// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
}

// ============================================================
// User: ホワイトリスト認証用ユーザー
// ============================================================
model User {
  id           Int           @id @default(autoincrement())
  email        String        @unique
  name         String?
  transactions Transaction[]
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  @@map("users")
}

// ============================================================
// Category: 支出カテゴリ
// ============================================================
model Category {
  id           Int            @id @default(autoincrement())
  name         String
  seq          Int            @default(0)
  rules        CategoryRule[]
  transactions Transaction[]
  createdAt    DateTime       @default(now()) @map("created_at")

  @@map("categories")
}

// ============================================================
// CategoryRule: カテゴリ自動分類ルール（学習辞書）
// ============================================================
model CategoryRule {
  id         Int      @id @default(autoincrement())
  categoryId Int      @map("category_id")
  keyword    String   @unique
  category   Category @relation(fields: [categoryId], references: [id])
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("category_rules")
}

// ============================================================
// DataSource: データソース（カード・口座）
// ============================================================
model DataSource {
  id           Int           @id @default(autoincrement())
  name         String        // "個人カード", "家族カード", "普通口座"
  type         String        // "card" | "bank"
  institution  String?       // "三井住友", "住信SBIネット銀行"
  transactions Transaction[]
  createdAt    DateTime      @default(now()) @map("created_at")

  @@map("data_sources")
}

// ============================================================
// Transaction: 家計簿明細（メインテーブル）
// ============================================================
model Transaction {
  id             Int           @id @default(autoincrement())
  userId         Int           @map("user_id")
  usageDate      DateTime      @map("usage_date")
  amount         Int           // 絶対値で保存
  description    String        @db.Text
  type           String        // "expense" | "income" | "transfer"
  categoryId     Int?          @map("category_id")
  dataSourceId   Int?          @map("data_source_id")
  isShared       Boolean       @default(false) @map("is_shared")
  settlementDate DateTime?     @map("settlement_date")
  hashKey          String        @unique @map("hash_key")
  receiptImageUrl  String?       @map("receipt_image_url")
  user             User          @relation(fields: [userId], references: [id])
  category         Category?     @relation(fields: [categoryId], references: [id])
  dataSource       DataSource?   @relation(fields: [dataSourceId], references: [id])
  receiptItems     ReceiptItem[]
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  @@map("transactions")
}

// ============================================================
// ReceiptItem: レシート明細（Transactionの子テーブル）
// ============================================================
model ReceiptItem {
  id              Int            @id @default(autoincrement())
  transactionId   Int            @map("transaction_id")
  name            String
  price           Int
  quantity        Int            @default(1)
  productMasterId Int?           @map("product_master_id")
  transaction     Transaction    @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  productMaster   ProductMaster? @relation(fields: [productMasterId], references: [id])
  createdAt       DateTime       @default(now()) @map("created_at")

  @@map("receipt_items")
}

// ============================================================
// Loan: 負債管理（ローン情報）
// ============================================================
model Loan {
  id          Int            @id @default(autoincrement())
  name        String         // ローン名（例: "住宅ローン"）
  totalAmount Int            @map("total_amount")
  startDate   DateTime       @map("start_date")
  endDate     DateTime       @map("end_date")
  schedules   LoanSchedule[]
  createdAt   DateTime       @default(now()) @map("created_at")

  @@map("loans")
}

// ============================================================
// LoanSchedule: 返済スケジュール
// ============================================================
model LoanSchedule {
  id          Int      @id @default(autoincrement())
  loanId      Int      @map("loan_id")
  dueDate     DateTime @map("due_date")
  amount      Int
  status      String   @default("unpaid") // "unpaid" | "paid"
  loan        Loan     @relation(fields: [loanId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("loan_schedules")
}

// ============================================================
// ProductMaster: 商品マスタ（品目正規化）
// ============================================================
model ProductMaster {
  id           Int                @id @default(autoincrement())
  name         String             @unique
  unit         String?            // 例: "kg", "g", "本", "個", "袋", "枚"
  receiptItems ReceiptItem[]
  aliases      ProductNameAlias[]
  createdAt    DateTime           @default(now()) @map("created_at")

  @@map("product_masters")
}

// ============================================================
// ProductNameAlias: 商品名エイリアス（rawName → ProductMaster）
// ============================================================
model ProductNameAlias {
  rawName         String        @id @map("raw_name")
  productMasterId Int           @map("product_master_id")
  productMaster   ProductMaster @relation(fields: [productMasterId], references: [id], onDelete: Cascade)

  @@map("product_name_aliases")
}
